/*
 * Equinix Fabric API v4
 *
 * Contact: api-support@equinix.com
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

package com.equinix.openapi.fabric.tests.helpers;

import com.equinix.openapi.fabric.*;
import com.equinix.openapi.fabric.tests.dto.TokenRequestDto;
import com.equinix.openapi.fabric.tests.dto.TokenResponseDto;
import com.equinix.openapi.fabric.tests.dto.users.UserUsedDto;
import com.equinix.openapi.fabric.tests.dto.users.UsersItem;
import com.google.gson.reflect.TypeToken;
import okhttp3.Interceptor;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.logging.HttpLoggingInterceptor;

import java.io.IOException;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;

public class TokenGenerator {

    public static Map<UsersItem.UserName, UserUsedDto> users = new HashMap<>();

    public static ApiClient getApiClient(UsersItem.UserName userName) {
        if (users.containsKey(userName)) {
            return users.get(userName).getApiClient();
        } else {
            return generate(userName);
        }
    }

    public static ApiClient generate(UsersItem.UserName userName) {
        if (users.containsKey(userName)) {
            users.remove(userName);
        }

        String baseUrl = System.getProperty("envUrl");
        UsersItem user = Utils.getUserData(userName);

        ApiClient apiTokenClient = Configuration.getDefaultApiClient();
        apiTokenClient.setHttpClient(getOkHttpClient(HttpLoggingInterceptor.Level.NONE));

        TokenRequestDto tokenRequestDto = new TokenRequestDto();
        tokenRequestDto.setClientId(user.getClientId());
        tokenRequestDto.setClientSecret(user.getClientSecret());
        tokenRequestDto.setGrantType("client_credentials");

        String localVarPath = "/oauth2/v1/token";

        List<Pair> localVarQueryParams = new ArrayList<Pair>();
        List<Pair> localVarCollectionQueryParams = new ArrayList<Pair>();
        Map<String, String> localVarHeaderParams = new HashMap<String, String>();
        Map<String, String> localVarCookieParams = new HashMap<String, String>();
        Map<String, Object> localVarFormParams = new HashMap<String, Object>();

        localVarHeaderParams.put("Content-Type", "application/json");
        String[] localVarAuthNames = new String[]{"BearerAuth"};

        okhttp3.Call call;
        TokenResponseDto tokenResponseDto = null;

        try {
            call = apiTokenClient.buildCall(baseUrl, localVarPath, "POST", localVarQueryParams, localVarCollectionQueryParams, tokenRequestDto, localVarHeaderParams
                    , localVarCookieParams, localVarFormParams, localVarAuthNames, null);

            Type localVarReturnType = new TypeToken<TokenResponseDto>() {
            }.getType();
            tokenResponseDto = (TokenResponseDto) apiTokenClient.execute(call, localVarReturnType).getData();
        } catch (ApiException e) {
            throw new RuntimeException(e);
        }

        ApiClient apiClient = Configuration.getDefaultApiClient().setBasePath(baseUrl);
        apiClient.addDefaultHeader("Authorization", String.format("Bearer %s", tokenResponseDto.getAccessToken()));
        apiClient.setHttpClient(getOkHttpClient(HttpLoggingInterceptor.Level.BODY));
        users.put(userName, new UserUsedDto(userName, apiClient));
        return users.get(userName).getApiClient();
    }

    private static OkHttpClient getOkHttpClient(HttpLoggingInterceptor.Level level) {
        OkHttpClient.Builder builder = new OkHttpClient.Builder();
        builder.readTimeout(0, TimeUnit.SECONDS);
        builder.writeTimeout(0, TimeUnit.SECONDS);
        builder.callTimeout(60, TimeUnit.SECONDS);
        builder.addNetworkInterceptor(getProgressInterceptor());
        builder.addInterceptor(new HttpLoggingInterceptor().setLevel(level));
        return builder.build();
    }

    private static Interceptor getProgressInterceptor() {
        return new Interceptor() {
            @Override
            public Response intercept(Interceptor.Chain chain) throws IOException {
                final Request request = chain.request();
                final Response originalResponse = chain.proceed(request);
                if (request.tag() instanceof ApiCallback) {
                    final ApiCallback callback = (ApiCallback) request.tag();
                    return originalResponse.newBuilder()
                            .body(new ProgressResponseBody(originalResponse.body(), callback))
                            .build();
                }
                return originalResponse;
            }
        };
    }
}
