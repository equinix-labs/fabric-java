/*
 * Equinix Fabric API v4
 *
 * Contact: api-support@equinix.com
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

package com.equinix.openapi.fabric.v4.api;

import com.equinix.openapi.fabric.ApiException;
import com.equinix.openapi.fabric.v4.api.dto.port.PortDto;
import com.equinix.openapi.fabric.v4.api.dto.users.UsersItem;
import com.equinix.openapi.fabric.v4.model.*;
import org.junit.AfterClass;
import org.junit.Test;

import java.util.List;
import java.util.Random;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.equinix.openapi.fabric.v4.api.TokenGenerator.users;
import static java.util.Collections.singletonList;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

public class ConnectionsApiTest {
    private static final UsersItem.UserName userName = UsersItem.UserName.PANTHERS_FNV;
    private static final ConnectionsApi api = new ConnectionsApi(TokenGenerator.getApiClient(userName));

    public static void removeConnections(UsersItem.UserName userName) {
        users.get(userName).getUserResources().getConnectionsUuid().forEach(uuid -> {
            try {
                deleteConnection(uuid);
            } catch (ApiException e) {
                throw new RuntimeException(e);
            }
        });
    }

    @AfterClass
    public static void removeResources() {
        removeConnections(userName);
        CloudRoutersApiTest.removeCloudRouters(userName);
    }

    @Test
    public void createConnectionPort2SP() throws ApiException {
        Connection connection = createPort2SpConnection();
        users.get(userName).getUserResources().addConnectionUuid(connection.getUuid());
        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PENDING_APPROVAL);
    }

    @Test
    public void createConnectionFCR2Port() throws ApiException {
        CloudRouter cloudRouter = CloudRoutersApiTest.createRouter(userName);

        Port port = PortsApiTest.getPorts(userName).getData().stream()
                .filter(p -> p.getName().contains("Dot1q"))
                .filter(p -> p.getLocation().getMetroCode().equals(cloudRouter.getLocation().getMetroCode()))
                .findFirst().get();

        UsersItem userDto = Utils.getUserData(UsersItem.UserName.PANTHERS_FCR);

        ConnectionPostRequest connectionPostRequest = getDefaultConnectionRequest("panthers-con-fcr-2-port")
                .type(ConnectionType.IP_VC)
                .project(new Project().projectId(userDto.getProjectId()))
                .aSide(new ConnectionSide().accessPoint(
                        new AccessPoint()
                                .type(AccessPointType.CLOUD_ROUTER)
                                .router(new CloudRouter().uuid(cloudRouter.getUuid()))));

        Connection connection = null;
        for (int i = 0; i < 3; i++) {
            int tag = new Random().nextInt(4000);
            connectionPostRequest.zSide(new ConnectionSide().accessPoint(
                    new AccessPoint()
                            .type(AccessPointType.COLO)
                            .port(new SimplifiedPort().uuid(port.getUuid()))
                            .linkProtocol(new SimplifiedLinkProtocol()
                                    .type(LinkProtocolType.DOT1Q)
                                    .vlanTag(tag))));

            connection = api.createConnection(connectionPostRequest);

            if (api.getApiClient().getStatusCode() == 201) {
                break;
            }
        }

        assertEquals(201, api.getApiClient().getStatusCode());

        users.get(userName).getUserResources().addConnectionUuid(connection.getUuid());
        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PENDING_APPROVAL);
    }

    @Test
    public void createConnectionPort2Port() throws ApiException {
        List<Port> port = PortsApiTest.getPorts(userName).getData().stream()
                .filter(p -> p.getName().contains("Dot1q"))
                .collect(Collectors.toList());

        Connection connection = null;

        for (int i = 0; i < 3; i++) {
            int tagAside = new Random().nextInt(4000);
            int tagZside = new Random().nextInt(4000);

            ConnectionPostRequest connectionPostRequest = getDefaultConnectionRequest("panthers-con-port-2-port")
                    .type(ConnectionType.EVPL_VC)

                    .redundancy(new ConnectionRedundancy().priority(ConnectionPriority.PRIMARY))
                    .aSide(new ConnectionSide().accessPoint(
                            new AccessPoint()
                                    .type(AccessPointType.COLO)
                                    .port(new SimplifiedPort()
                                            .uuid(port.get(0).getUuid()))
                                    .linkProtocol(new SimplifiedLinkProtocol()
                                            .type(LinkProtocolType.DOT1Q).vlanTag(tagAside))))
                    .zSide(new ConnectionSide().accessPoint(
                            new AccessPoint()
                                    .type(AccessPointType.COLO)
                                    .port(new SimplifiedPort()
                                            .uuid(port.get(1).getUuid()))
                                    .linkProtocol(new SimplifiedLinkProtocol()
                                            .type(LinkProtocolType.DOT1Q)
                                            .vlanTag(tagZside))));

            connection = api.createConnection(connectionPostRequest);

            if (api.getApiClient().getStatusCode() == 201) {
                break;
            }
        }

        assertEquals(201, api.getApiClient().getStatusCode());
        users.get(userName).getUserResources().addConnectionUuid(connection.getUuid());
        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PROVISIONED);
    }

    /**
     * Successful operation
     */
    @Test
    public void searchConnections() throws ApiException {
        ConnectionSearchResponse connectionSearchResponse = getConnections();

        assertEquals(200, api.getApiClient().getStatusCode());
        connectionSearchResponse.getData().forEach(connection -> assertEquals(connection.getOperation().getProviderStatus(), ProviderStatus.AVAILABLE));
    }

    //
//    /**
//     * Successful operation
//     */
//    @Test
//    public void getConnectionByUuid() {
//        Response searchResponse = getConnections();
//        ConnectionSearchResponse connectionSearchResponse = searchResponse.as(ConnectionSearchResponse.class);
//        Connection randomConnection = connectionSearchResponse.getData().get(new Random().nextInt(connectionSearchResponse.getData().size()));
//
//        Response response = api.getConnectionByUuid().connectionIdPath(randomConnection.getUuid()).execute(r -> r);
//
//        Connection connection = response.as(Connection.class);
//
//        assertEquals(200, api.getApiClient().getStatusCode());
//        assertEquals(randomConnection.getUuid(), connection.getUuid());
//        assertEquals(randomConnection.getName(), connection.getName());
//    }
//
//    /**
//     * Delete Connection Request
//     */
//    @Test
//    public void deleteConnectionByUuid() {
//        Connection connection = createPort2SpConnection();
//        Response response = api.deleteConnectionByUuid()
//                .connectionIdPath(connection.getUuid()).execute(r -> r);
//        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PENDING_INTERFACE_CONFIGURATION);
//        assertEquals(HttpStatus.SC_ACCEPTED, api.getApiClient().getStatusCode());
//    }
//
//    /**
//     * Successful operation
//     */
//    @Test
//    public void updateConnectionByUuid() {
//        Connection connection = createPort2SpConnection();
//        connectionsToDelete.add(connection.getUuid());
//        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PENDING_INTERFACE_CONFIGURATION);
//
//        Port port = PortsApiTest.getPorts().as(AllPortsResponse.class).getData().stream()
//                .filter(p -> p.getName().contains("Dot1q"))
//                .filter(p -> p.getLocation().getMetroCode().equals(connection.getaSide().getAccessPoint().getLocation().getMetroCode()))
//                .findFirst().get();
//
//        ConnectionActionRequest connectionActionRequest = new ConnectionActionRequest()
//                .type(Actions.CONNECTION_CREATION_ACCEPTANCE)
//                .data(new ConnectionAcceptanceData()
//                        .zSide(new ConnectionSide()
//                                .accessPoint(new AccessPoint()
//                                        .type(AccessPointType.COLO)
//                                        .port(new SimplifiedPort().uuid(port.getUuid()))
//                                        .linkProtocol(new SimplifiedLinkProtocol()
//                                                .type(LinkProtocolType.DOT1Q).vlanTag(123)
//                                        ))));
//
//        Response ree = api.createConnectionAction()
//                .connectionIdPath(connection.getUuid())
//                .body(connectionActionRequest).execute(r -> r);
//
//        assertEquals(HttpStatus.SC_ACCEPTED, ree.getStatusCode());
//
//        waitForConnectionIsInState(connection.getUuid(), EquinixStatus.PROVISIONED);
//
//        String updatedName = "updated_p2p_connection";
//
//        ConnectionChangeOperation connectionChangeOperation = new ConnectionChangeOperation()
//                .op(OpEnum.REPLACE.getValue())
//                .path("/name")
//                .value(updatedName);
//
//        Response response = api.updateConnectionByUuid()
//                .connectionIdPath(connection.getUuid())
//                .body(singletonList(connectionChangeOperation)).execute(r -> r);
//
//        Connection updatedConnection = response.as(Connection.class);
//        assertEquals(HttpStatus.SC_ACCEPTED, api.getApiClient().getStatusCode());
//
//        for (int i = 0; i < 5; i++) {
//            updatedConnection = api.getConnectionByUuid()
//                    .connectionIdPath(connection.getUuid())
//                    .execute(re -> re).as(Connection.class);
//
//            if (updatedConnection.getName().equals(updatedName)) {
//                break;
//            }
//            try {
//                Thread.sleep(3000);
//            } catch (InterruptedException e) {
//                throw new RuntimeException(e);
//            }
//        }
//        assertEquals(updatedConnection.getName(), updatedName);
//    }
//
    private Connection createPort2SpConnection() throws ApiException {
        ServiceProfile serviceProfile = new ServiceProfilesApiTest().getServiceProfilesByQueryResponse("zSide")
                .getData().stream().filter(sp -> sp.getState().equals(ServiceProfileStateEnum.ACTIVE))
                .findAny().get();

        PortDto portDto = (PortDto) Utils.getEnvData(Utils.EnvVariable.QINQ_PORT);

        ConnectionPostRequest connectionPostRequest = getDefaultConnectionRequest("panthers-con-port-2-sp")
                .type(ConnectionType.EVPL_VC)
                .redundancy(new ConnectionRedundancy().priority(ConnectionPriority.PRIMARY))
                .order(new Order().purchaseOrderNumber("pol123"))
                .zSide(new ConnectionSide().accessPoint(
                        new AccessPoint()
                                .type(AccessPointType.SP)
                                .profile(new SimplifiedServiceProfile()
                                        .type(ServiceProfileTypeEnum.L2_PROFILE)
                                        .uuid(serviceProfile.getUuid()))
                                .location(new SimplifiedLocation()
                                        .metroCode(serviceProfile.getMetros().get(0).getCode()))));

        Connection connection = null;

        for (int i = 0; i < 3; i++) {
            int sTag = new Random().nextInt(4000);
            int cTag = new Random().nextInt(4000);
            connectionPostRequest.aSide(new ConnectionSide().accessPoint(
                    new AccessPoint()
                            .type(AccessPointType.COLO)
                            .port(new SimplifiedPort().uuid(UUID.fromString(portDto.getUuid())))
                            .linkProtocol(new SimplifiedLinkProtocol()
                                    .type(LinkProtocolType.QINQ)
                                    .vlanSTag(sTag)
                                    .vlanCTag(cTag))));

            connection = api.createConnection(connectionPostRequest);

            if (api.getApiClient().getStatusCode() == 201) {
                break;
            }
        }

        assertEquals(201, api.getApiClient().getStatusCode());

        return connection;
    }

    private ConnectionPostRequest getDefaultConnectionRequest(String name) {
        return new ConnectionPostRequest()
                .name(name)
                .bandwidth(1000)
                .notifications(singletonList(new SimplifiedNotification()
                        .type(SimplifiedNotification.TypeEnum.ALL)
                        .emails(singletonList("test@test.com"))));
    }

    private static void deleteConnection(String uuid) throws ApiException {
        api.deleteConnectionByUuid(uuid);
        assertEquals(202, api.getApiClient().getStatusCode());
        waitForConnectionIsInState(uuid, EquinixStatus.DELETED);
    }

    private static void waitForConnectionIsInState(String connectionUuid, EquinixStatus connectionState) throws ApiException {
        boolean result = false;
        for (int i = 0; i < 5; i++) {
            Connection connection = api.getConnectionByUuid(connectionUuid, null);

            if (connection.getOperation().getEquinixStatus().equals(connectionState)) {
                result = true;
                break;
            }
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }

        assertTrue(result, "Connection ha not reached the expected state: " + connectionState);
    }

    private ConnectionSearchResponse getConnections() throws ApiException {
        SearchRequest searchRequest = new SearchRequest()
                .filter(new Expression()
                        .addAndItem(new Expression()
                                .property(SearchFieldName._OPERATION_PROVIDERSTATUS)
                                .operator(Expression.OperatorEnum.EQUAL)
                                .values(singletonList(ProviderStatus.AVAILABLE.getValue()))))
                .pagination(new PaginationRequest().limit(5).offset(10))
                .sort(singletonList(new SortCriteria().property(SortBy.CHANGELOG_UPDATEDDATETIME).direction(SortDirection.DESC)));

        return api.searchConnections(searchRequest);
    }
}
